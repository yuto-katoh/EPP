!-----------------------------------------------------------------------
module p__passv
!-----------------------------------------------------------------------
  use c__eprm,  only: lxa1,npa1,mfopt
  use v__in,    only: delt,q
  use p__initmg,only: delx
  implicit none
!
  private
  public :: passv
!
  contains
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
  subroutine passv( xx,vp1,pm1,lor,bf,pind )
!-----------------------------------------------------------------------
    real(kind=8)   ,intent(inout) ::  vp1(3,npa1)
    real(kind=8)   ,intent(inout) ::  pm1(3,npa1),lor(npa1)
    real(kind=8)   ,intent(in)    ::  xx(npa1)
    real(kind=8)   ,intent(in)    ::  bf(lxa1)
    integer(kind=4),intent(in)    ::  pind(npa1)
!
    real(kind=8)  ::  aa,raa1,dd1,dd2
    real(kind=8) ::   fbx,btot1,btot2,dbds,dvdt
    real(kind=8) ::   pmyu,vpp2,vpara,vperp,lort,rlar
    real(kind=8) ::   half, fact1, fact2, fact3
    integer           ii,ic
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
    half  = 0.5d0
    fact1 = q(2,1)
    fact2 = q(2,2)
    fact3 = fact2/fact1
!-----------------------------------------------------------------------
    do ii=1,npa1
!-----------------------------------------------------------------------
      if(pind(ii).eq.0) then
      !-----------------------------------------------------------------------

        vpp2 = vp1(1,ii)**2 + vp1(2,ii)**2
        vpara = vp1(1,ii)
        vperp = vp1(2,ii)
!-----------------------------------------------------------------------
        aa = xx(ii) / delx
        raa1 = dint( aa+half )
        ic = raa1
        dd1 = aa+half-raa1
        dd2 = raa1-aa+half
!-----------------------------------------------------------------------
        fbx = bf(ic)*dd1 + bf(ic-1)*dd2
        btot1 = bf(ic)
        btot2 = bf(ic-1)
        dbds = (btot1 - btot2)/delx
!-----------------------------------------------------------------------
        lort = 1.d0/sqrt(1.d0 - vpp2 )
        rlar = vperp/fbx
        dvdt = 0.5d0*rlar*vperp*dbds*fact3 *mfopt
!-----------------------------------------------------------------------
        vp1(1,ii) = vp1(1,ii) + dvdt*delt(ii)
        vp1(2,ii) = sqrt(vpp2 - vp1(1,ii)**2)
!-----------------------------------------------------------------------
        lor(ii) = vp1(1,ii)**2 + vp1(2,ii)**2
        lor(ii) = 1.d0/sqrt( 1.d0 - lor(ii) )
!-----------------------------------------------------------------------
        pm1(1,ii) = vp1(1,ii)*lor(ii)
        pm1(2,ii) = vp1(2,ii)*lor(ii)
!-----------------------------------------------------------------------
     end if

!-----------------------------------------------------------------------
    end do
!-----------------------------------------------------------------------
    return
!-----------------------------------------------------------------------
  end subroutine passv
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
end module p__passv
